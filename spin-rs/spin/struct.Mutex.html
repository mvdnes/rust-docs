<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="API documentation for the Rust `Mutex` struct in crate `spin`."><meta name="keywords" content="rust, rustlang, rust-lang, Mutex"><title>spin::Mutex - Rust</title><link rel="stylesheet" type="text/css" href="../normalize.css"><link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../dark.css"><link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle"><script src="../storage.js"></script></head><body class="rustdoc struct"><!--[if lte IE 8]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="sidebar"><div class="sidebar-menu">&#9776;</div><p class='location'>Struct Mutex</p><div class="sidebar-elems"><div class="block items"><a class="sidebar-title" href="#methods">Methods</a><div class="sidebar-links"><a href="#method.new">new</a><a href="#method.into_inner">into_inner</a><a href="#method.lock">lock</a><a href="#method.force_unlock">force_unlock</a><a href="#method.try_lock">try_lock</a></div><a class="sidebar-title" href="#implementations">Trait Implementations</a><div class="sidebar-links"><a href="#impl-Sync">Sync</a><a href="#impl-Send">Send</a><a href="#impl-Debug">Debug</a><a href="#impl-Default">Default</a></div></div><p class='location'><a href='index.html'>spin</a></p><script>window.sidebarCurrent = {name: 'Mutex', ty: 'struct', relpath: ''};</script><script defer src="sidebar-items.js"></script></div></nav><div class="theme-picker"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg" width="18" alt="Pick another theme!"></button><div id="theme-choices"></div></div><script src="../theme.js"></script><nav class="sub"><form class="search-form js-only"><div class="search-container"><input class="search-input" name="search" autocomplete="off" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><a id="settings-menu" href="../settings.html"><img src="../wheel.svg" width="18" alt="Change settings"></a></div></form></nav><section id="main" class="content"><h1 class='fqn'><span class='in-band'>Struct <a href='index.html'>spin</a>::<wbr><a class="struct" href=''>Mutex</a></span><span class='out-of-band'><span id='render-detail'><a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class='inner'>&#x2212;</span>]</a></span><a class='srclink' href='../src/spin/mutex.rs.html#78-82' title='goto source code'>[src]</a></span></h1><div class="docblock type-decl"><pre class='rust struct'>pub struct Mutex&lt;T:&nbsp;?<a class="trait" href="https://doc.rust-lang.org/nightly/core/marker/trait.Sized.html" title="trait core::marker::Sized">Sized</a>&gt; { /* fields omitted */ }</pre></div><div class='docblock'><p>This type provides MUTual EXclusion based on spinning.</p>
<h1 id="description" class="section-header"><a href="#description">Description</a></h1>
<p>This structure behaves a lot like a normal Mutex. There are some differences:</p>
<ul>
<li>It may be used outside the runtime.
<ul>
<li>A normal mutex will fail when used without the runtime, this will just lock</li>
<li>When the runtime is present, it will call the deschedule function when appropriate</li>
</ul>
</li>
<li>No lock poisoning. When a fail occurs when the lock is held, no guarantees are made</li>
</ul>
<p>When calling rust functions from bare threads, such as C <code>pthread</code>s, this lock will be very
helpful. In other cases however, you are encouraged to use the locks from the standard
library.</p>
<h1 id="simple-examples" class="section-header"><a href="#simple-examples">Simple examples</a></h1>
<pre class="rust rust-example-rendered">
<span class="kw">use</span> <span class="ident">spin</span>;
<span class="kw">let</span> <span class="ident">spin_mutex</span> <span class="op">=</span> <span class="ident">spin</span>::<span class="ident">Mutex</span>::<span class="ident">new</span>(<span class="number">0</span>);

<span class="comment">// Modify the data</span>
{
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">data</span> <span class="op">=</span> <span class="ident">spin_mutex</span>.<span class="ident">lock</span>();
    <span class="kw-2">*</span><span class="ident">data</span> <span class="op">=</span> <span class="number">2</span>;
}

<span class="comment">// Read the data</span>
<span class="kw">let</span> <span class="ident">answer</span> <span class="op">=</span>
{
    <span class="kw">let</span> <span class="ident">data</span> <span class="op">=</span> <span class="ident">spin_mutex</span>.<span class="ident">lock</span>();
    <span class="kw-2">*</span><span class="ident">data</span>
};

<span class="macro">assert_eq</span><span class="macro">!</span>(<span class="ident">answer</span>, <span class="number">2</span>);</pre>
<h1 id="thread-safety-example" class="section-header"><a href="#thread-safety-example">Thread-safety example</a></h1>
<pre class="rust rust-example-rendered">
<span class="kw">use</span> <span class="ident">spin</span>;
<span class="kw">use</span> <span class="ident">std</span>::<span class="ident">sync</span>::{<span class="ident">Arc</span>, <span class="ident">Barrier</span>};

<span class="kw">let</span> <span class="ident">numthreads</span> <span class="op">=</span> <span class="number">1000</span>;
<span class="kw">let</span> <span class="ident">spin_mutex</span> <span class="op">=</span> <span class="ident">Arc</span>::<span class="ident">new</span>(<span class="ident">spin</span>::<span class="ident">Mutex</span>::<span class="ident">new</span>(<span class="number">0</span>));

<span class="comment">// We use a barrier to ensure the readout happens after all writing</span>
<span class="kw">let</span> <span class="ident">barrier</span> <span class="op">=</span> <span class="ident">Arc</span>::<span class="ident">new</span>(<span class="ident">Barrier</span>::<span class="ident">new</span>(<span class="ident">numthreads</span> <span class="op">+</span> <span class="number">1</span>));

<span class="kw">for</span> <span class="kw">_</span> <span class="kw">in</span> (<span class="number">0</span>..<span class="ident">numthreads</span>)
{
    <span class="kw">let</span> <span class="ident">my_barrier</span> <span class="op">=</span> <span class="ident">barrier</span>.<span class="ident">clone</span>();
    <span class="kw">let</span> <span class="ident">my_lock</span> <span class="op">=</span> <span class="ident">spin_mutex</span>.<span class="ident">clone</span>();
    <span class="ident">std</span>::<span class="ident">thread</span>::<span class="ident">spawn</span>(<span class="kw">move</span><span class="op">||</span>
    {
        <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">guard</span> <span class="op">=</span> <span class="ident">my_lock</span>.<span class="ident">lock</span>();
        <span class="kw-2">*</span><span class="ident">guard</span> <span class="op">+=</span> <span class="number">1</span>;

        <span class="comment">// Release the lock to prevent a deadlock</span>
        <span class="ident">drop</span>(<span class="ident">guard</span>);
        <span class="ident">my_barrier</span>.<span class="ident">wait</span>();
    });
}

<span class="ident">barrier</span>.<span class="ident">wait</span>();

<span class="kw">let</span> <span class="ident">answer</span> <span class="op">=</span> { <span class="kw-2">*</span><span class="ident">spin_mutex</span>.<span class="ident">lock</span>() };
<span class="macro">assert_eq</span><span class="macro">!</span>(<span class="ident">answer</span>, <span class="ident">numthreads</span>);</pre>
</div><h2 id='methods' class='small-section-header'>Methods<a href='#methods' class='anchor'></a></h2><h3 id='impl' class='impl'><span class='in-band'><table class='table-display'><tbody><tr><td><code>impl&lt;T&gt; <a class="struct" href="../spin/struct.Mutex.html" title="struct spin::Mutex">Mutex</a>&lt;T&gt;</code><a href='#impl' class='anchor'></a></span></td><td><span class='out-of-band'><div class='ghost'></div><a class='srclink' href='../src/spin/mutex.rs.html#97-156' title='goto source code'>[src]</a></span></td></tr></tbody></table></h3><div class='impl-items'><h4 id='method.new' class="method"><span id='new.v' class='invisible'><table class='table-display'><tbody><tr><td><code>pub const fn <a href='#method.new' class='fnname'>new</a>(user_data: T) -&gt; <a class="struct" href="../spin/struct.Mutex.html" title="struct spin::Mutex">Mutex</a>&lt;T&gt;</code></span></td><td><span class='out-of-band'><div class='ghost'></div><a class='srclink' href='../src/spin/mutex.rs.html#116-123' title='goto source code'>[src]</a></td></tr></tbody></table></span></h4><div class='docblock'><p>Creates a new spinlock wrapping the supplied data.</p>
<p>May be used statically:</p>

<pre class="rust rust-example-rendered">
<span class="attribute">#![<span class="ident">feature</span>(<span class="ident">const_fn</span>)]</span>
<span class="kw">use</span> <span class="ident">spin</span>;

<span class="kw">static</span> <span class="ident">MUTEX</span>: <span class="ident">spin</span>::<span class="ident">Mutex</span><span class="op">&lt;</span>()<span class="op">&gt;</span> <span class="op">=</span> <span class="ident">spin</span>::<span class="ident">Mutex</span>::<span class="ident">new</span>(());

<span class="kw">fn</span> <span class="ident">demo</span>() {
    <span class="kw">let</span> <span class="ident">lock</span> <span class="op">=</span> <span class="ident">MUTEX</span>.<span class="ident">lock</span>();
    <span class="comment">// do something with lock</span>
    <span class="ident">drop</span>(<span class="ident">lock</span>);
}</pre>
</div><h4 id='method.into_inner' class="method"><span id='into_inner.v' class='invisible'><table class='table-display'><tbody><tr><td><code>pub fn <a href='#method.into_inner' class='fnname'>into_inner</a>(self) -&gt; T</code></span></td><td><span class='out-of-band'><div class='ghost'></div><a class='srclink' href='../src/spin/mutex.rs.html#150-155' title='goto source code'>[src]</a></td></tr></tbody></table></span></h4><div class='docblock'><p>Consumes this mutex, returning the underlying data.</p>
</div></div><h3 id='impl-1' class='impl'><span class='in-band'><table class='table-display'><tbody><tr><td><code>impl&lt;T:&nbsp;?<a class="trait" href="https://doc.rust-lang.org/nightly/core/marker/trait.Sized.html" title="trait core::marker::Sized">Sized</a>&gt; <a class="struct" href="../spin/struct.Mutex.html" title="struct spin::Mutex">Mutex</a>&lt;T&gt;</code><a href='#impl-1' class='anchor'></a></span></td><td><span class='out-of-band'><div class='ghost'></div><a class='srclink' href='../src/spin/mutex.rs.html#158-226' title='goto source code'>[src]</a></span></td></tr></tbody></table></h3><div class='impl-items'><h4 id='method.lock' class="method"><span id='lock.v' class='invisible'><table class='table-display'><tbody><tr><td><code>pub fn <a href='#method.lock' class='fnname'>lock</a>(&amp;self) -&gt; <a class="struct" href="../spin/struct.MutexGuard.html" title="struct spin::MutexGuard">MutexGuard</a>&lt;T&gt;</code></span></td><td><span class='out-of-band'><div class='ghost'></div><a class='srclink' href='../src/spin/mutex.rs.html#187-195' title='goto source code'>[src]</a></td></tr></tbody></table></span></h4><div class='docblock'><p>Locks the spinlock and returns a guard.</p>
<p>The returned value may be dereferenced for data access
and the lock will be dropped when the guard falls out of scope.</p>

<pre class="rust rust-example-rendered">
<span class="kw">let</span> <span class="ident">mylock</span> <span class="op">=</span> <span class="ident">spin</span>::<span class="ident">Mutex</span>::<span class="ident">new</span>(<span class="number">0</span>);
{
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">data</span> <span class="op">=</span> <span class="ident">mylock</span>.<span class="ident">lock</span>();
    <span class="comment">// The lock is now locked and the data can be accessed</span>
    <span class="kw-2">*</span><span class="ident">data</span> <span class="op">+=</span> <span class="number">1</span>;
    <span class="comment">// The lock is implicitly dropped</span>
}
</pre>
</div><h4 id='method.force_unlock' class="method"><span id='force_unlock.v' class='invisible'><table class='table-display'><tbody><tr><td><code>pub unsafe fn <a href='#method.force_unlock' class='fnname'>force_unlock</a>(&amp;self)</code></span></td><td><span class='out-of-band'><div class='ghost'></div><a class='srclink' href='../src/spin/mutex.rs.html#204-206' title='goto source code'>[src]</a></td></tr></tbody></table></span></h4><div class='docblock'><p>Force unlock the spinlock.</p>
<p>This is <em>extremely</em> unsafe if the lock is not held by the current
thread. However, this can be useful in some instances for exposing the
lock to FFI that doesn't know how to deal with RAII.</p>
<p>If the lock isn't held, this is a no-op.</p>
</div><h4 id='method.try_lock' class="method"><span id='try_lock.v' class='invisible'><table class='table-display'><tbody><tr><td><code>pub fn <a href='#method.try_lock' class='fnname'>try_lock</a>(&amp;self) -&gt; <a class="enum" href="https://doc.rust-lang.org/nightly/core/option/enum.Option.html" title="enum core::option::Option">Option</a>&lt;<a class="struct" href="../spin/struct.MutexGuard.html" title="struct spin::MutexGuard">MutexGuard</a>&lt;T&gt;&gt;</code></span></td><td><span class='out-of-band'><div class='ghost'></div><a class='srclink' href='../src/spin/mutex.rs.html#210-225' title='goto source code'>[src]</a></td></tr></tbody></table></span></h4><div class='docblock'><p>Tries to lock the mutex. If it is already locked, it will return None. Otherwise it returns
a guard within Some.</p>
</div></div><h2 id='implementations' class='small-section-header'>Trait Implementations<a href='#implementations' class='anchor'></a></h2><div id='implementations-list'><h3 id='impl-Sync' class='impl'><span class='in-band'><table class='table-display'><tbody><tr><td><code>impl&lt;T:&nbsp;?<a class="trait" href="https://doc.rust-lang.org/nightly/core/marker/trait.Sized.html" title="trait core::marker::Sized">Sized</a> + <a class="trait" href="https://doc.rust-lang.org/nightly/core/marker/trait.Send.html" title="trait core::marker::Send">Send</a>&gt; <a class="trait" href="https://doc.rust-lang.org/nightly/core/marker/trait.Sync.html" title="trait core::marker::Sync">Sync</a> for <a class="struct" href="../spin/struct.Mutex.html" title="struct spin::Mutex">Mutex</a>&lt;T&gt;</code><a href='#impl-Sync' class='anchor'></a></span></td><td><span class='out-of-band'><div class='ghost'></div><a class='srclink' href='../src/spin/mutex.rs.html#94' title='goto source code'>[src]</a></span></td></tr></tbody></table></h3><div class='impl-items'></div><h3 id='impl-Send' class='impl'><span class='in-band'><table class='table-display'><tbody><tr><td><code>impl&lt;T:&nbsp;?<a class="trait" href="https://doc.rust-lang.org/nightly/core/marker/trait.Sized.html" title="trait core::marker::Sized">Sized</a> + <a class="trait" href="https://doc.rust-lang.org/nightly/core/marker/trait.Send.html" title="trait core::marker::Send">Send</a>&gt; <a class="trait" href="https://doc.rust-lang.org/nightly/core/marker/trait.Send.html" title="trait core::marker::Send">Send</a> for <a class="struct" href="../spin/struct.Mutex.html" title="struct spin::Mutex">Mutex</a>&lt;T&gt;</code><a href='#impl-Send' class='anchor'></a></span></td><td><span class='out-of-band'><div class='ghost'></div><a class='srclink' href='../src/spin/mutex.rs.html#95' title='goto source code'>[src]</a></span></td></tr></tbody></table></h3><div class='impl-items'></div><h3 id='impl-Debug' class='impl'><span class='in-band'><table class='table-display'><tbody><tr><td><code>impl&lt;T:&nbsp;?<a class="trait" href="https://doc.rust-lang.org/nightly/core/marker/trait.Sized.html" title="trait core::marker::Sized">Sized</a> + <a class="trait" href="https://doc.rust-lang.org/nightly/core/fmt/trait.Debug.html" title="trait core::fmt::Debug">Debug</a>&gt; <a class="trait" href="https://doc.rust-lang.org/nightly/core/fmt/trait.Debug.html" title="trait core::fmt::Debug">Debug</a> for <a class="struct" href="../spin/struct.Mutex.html" title="struct spin::Mutex">Mutex</a>&lt;T&gt;</code><a href='#impl-Debug' class='anchor'></a></span></td><td><span class='out-of-band'><div class='ghost'></div><a class='srclink' href='../src/spin/mutex.rs.html#228-238' title='goto source code'>[src]</a></span></td></tr></tbody></table></h3><div class='impl-items'><h4 id='method.fmt' class="method"><span id='fmt.v' class='invisible'><table class='table-display'><tbody><tr><td><code>fn <a href='https://doc.rust-lang.org/nightly/core/fmt/trait.Debug.html#tymethod.fmt' class='fnname'>fmt</a>(&amp;self, f: &amp;mut <a class="struct" href="https://doc.rust-lang.org/nightly/core/fmt/struct.Formatter.html" title="struct core::fmt::Formatter">Formatter</a>) -&gt; <a class="type" href="https://doc.rust-lang.org/nightly/core/fmt/type.Result.html" title="type core::fmt::Result">Result</a></code></span></td><td><span class='out-of-band'><div class='ghost'></div><a class='srclink' href='../src/spin/mutex.rs.html#230-237' title='goto source code'>[src]</a></td></tr></tbody></table></span></h4><div class='docblock'><p>Formats the value using the given formatter. <a href="https://doc.rust-lang.org/nightly/core/fmt/trait.Debug.html#tymethod.fmt">Read more</a></p>
</div></div><h3 id='impl-Default' class='impl'><span class='in-band'><table class='table-display'><tbody><tr><td><code>impl&lt;T:&nbsp;?<a class="trait" href="https://doc.rust-lang.org/nightly/core/marker/trait.Sized.html" title="trait core::marker::Sized">Sized</a> + <a class="trait" href="https://doc.rust-lang.org/nightly/core/default/trait.Default.html" title="trait core::default::Default">Default</a>&gt; <a class="trait" href="https://doc.rust-lang.org/nightly/core/default/trait.Default.html" title="trait core::default::Default">Default</a> for <a class="struct" href="../spin/struct.Mutex.html" title="struct spin::Mutex">Mutex</a>&lt;T&gt;</code><a href='#impl-Default' class='anchor'></a></span></td><td><span class='out-of-band'><div class='ghost'></div><a class='srclink' href='../src/spin/mutex.rs.html#240-244' title='goto source code'>[src]</a></span></td></tr></tbody></table></h3><div class='impl-items'><h4 id='method.default' class="method"><span id='default.v' class='invisible'><table class='table-display'><tbody><tr><td><code>fn <a href='https://doc.rust-lang.org/nightly/core/default/trait.Default.html#tymethod.default' class='fnname'>default</a>() -&gt; <a class="struct" href="../spin/struct.Mutex.html" title="struct spin::Mutex">Mutex</a>&lt;T&gt;</code></span></td><td><span class='out-of-band'><div class='ghost'></div><a class='srclink' href='../src/spin/mutex.rs.html#241-243' title='goto source code'>[src]</a></td></tr></tbody></table></span></h4><div class='docblock'><p>Returns the &quot;default value&quot; for a type. <a href="https://doc.rust-lang.org/nightly/core/default/trait.Default.html#tymethod.default">Read more</a></p>
</div></div></div></section><section id="search" class="content hidden"></section><section class="footer"></section><aside id="help" class="hidden"><div><h1 class="hidden">Help</h1><div class="shortcuts"><h2>Keyboard Shortcuts</h2><dl><dt><kbd>?</kbd></dt><dd>Show this help dialog</dd><dt><kbd>S</kbd></dt><dd>Focus the search field</dd><dt><kbd>↑</kbd></dt><dd>Move up in search results</dd><dt><kbd>↓</kbd></dt><dd>Move down in search results</dd><dt><kbd>↹</kbd></dt><dd>Switch tab</dd><dt><kbd>&#9166;</kbd></dt><dd>Go to active search result</dd><dt><kbd>+</kbd></dt><dd>Expand all sections</dd><dt><kbd>-</kbd></dt><dd>Collapse all sections</dd></dl></div><div class="infos"><h2>Search Tricks</h2><p>Prefix searches with a type followed by a colon (e.g. <code>fn:</code>) to restrict the search to a given type.</p><p>Accepted types are: <code>fn</code>, <code>mod</code>, <code>struct</code>, <code>enum</code>, <code>trait</code>, <code>type</code>, <code>macro</code>, and <code>const</code>.</p><p>Search functions by type signature (e.g. <code>vec -> usize</code> or <code>* -> vec</code>)</p><p>Search multiple things at once by splitting your query with comma (e.g. <code>str,u8</code> or <code>String,struct:Vec,test</code>)</p></div></div></aside><script>window.rootPath = "../";window.currentCrate = "spin";</script><script src="../aliases.js"></script><script src="../main.js"></script><script defer src="../search-index.js"></script></body></html>